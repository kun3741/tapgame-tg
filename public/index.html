<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tap Game</title>
    <style>
        body { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background-color: #f0f0f0; font-family: Arial, sans-serif; }
        #tap-button { padding: 20px; font-size: 24px; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 5px; }
        #upgrade-button { margin-top: 10px; padding: 10px; font-size: 16px; cursor: pointer; background-color: #2196F3; color: white; border: none; border-radius: 5px; }
        #profile-button { margin-top: 10px; padding: 10px; font-size: 16px; cursor: pointer; background-color: #FFC107; color: white; border: none; border-radius: 5px; }
        #balance { margin-top: 20px; font-size: 20px; }
        #error-message { color: red; margin-top: 20px; }
    </style>
</head>
<body>
    <button id="tap-button">Tap me!</button>
    <button id="upgrade-button">Upgrade (Cost: <span id="upgrade-cost">10</span> coins)</button>
    <button id="profile-button">Go to Profile</button>
    <div id="balance">Balance: 0 coins</div>
    <div id="level">Update level: 0</div>
    <div id="error-message"></div>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const telegramId = urlParams.get('telegramId');
        let coins = 0;
        let upgradeLevel = 1;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(`/api/user/${telegramId}`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const user = await response.json();
                validateAndInitializeUserData(user);
            } catch (error) {
                displayError('Error fetching user data: ' + error.message);
                console.error('Error fetching user data:', error);
            }

            document.getElementById('tap-button').addEventListener('click', async () => {
                coins += upgradeLevel;
                updateUI();
                await updateUser();
            });

            document.getElementById('upgrade-button').addEventListener('click', async () => {
                const upgradeCost = upgradeLevel * 10;
                if (coins >= upgradeCost) {
                    coins -= upgradeCost;
                    upgradeLevel++;
                    updateUI();
                    await updateUser();
                }
            });

            document.getElementById('profile-button').addEventListener('click', () => {
                window.location.href = `/profileView.html?telegramId=${telegramId}`;
            });

            window.addEventListener('beforeunload', async () => {
                await updateUser();
            });
        });

        function validateAndInitializeUserData(user) {
            if (typeof user.coins !== 'number' || typeof user.upgradeLevel !== 'number') {
                displayError('Invalid user data received.');
                return;
            }
            coins = user.coins;
            upgradeLevel = user.upgradeLevel;

            updateUI();
        }

        function updateUI() {
            document.getElementById('tap-button').textContent = `Taps: ${coins}`;
            document.getElementById('upgrade-cost').textContent = upgradeLevel * 10;
            document.getElementById('balance').textContent = `Balance: ${coins} coins`;
            document.getElementById('level').textContent = `Update level: ${upgradeLevel}`;
        }

        async function updateUser() {
            try {
                await fetch('/api/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegramId, coins, upgradeLevel })
                });
                console.log('User data updated:', { coins, upgradeLevel });
            } catch (error) {
                displayError('Error updating user data: ' + error.message);
                console.error('Error updating user data:', error);
            }
        }

        function displayError(message) {
            const errorMessageElement = document.getElementById('error-message');
            errorMessageElement.textContent = message;
        }
    </script>
</body>
</html>
